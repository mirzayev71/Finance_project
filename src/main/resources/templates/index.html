<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker - Professional</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr Dark Theme (Optional, fits modern look) -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css"> -->

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .balance-card {
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
        }

        .income-card {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        .expense-card {
            background: linear-gradient(45deg, #eb3349, #f45c43);
        }

        .debt-card {
            background: linear-gradient(45deg, #834d9b, #d04ed6);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .progress {
            height: 15px;
            border-radius: 10px;
            background-color: #e9ecef;
        }

        .btn-action {
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        /* Badges */
        .badge-custom {
            padding: 8px 12px;
            border-radius: 30px;
            font-weight: 500;
        }

        .badge-income {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .badge-expense {
            background-color: #f8d7da;
            color: #842029;
        }

        .badge-unpaid {
            background-color: #fff3cd;
            color: #664d03;
        }

        .badge-paid {
            background-color: #e2e3e5;
            color: #41464b;
        }
    </style>
</head>

<body>
    <div class="container py-4">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <!-- Brand Logo -->
            <div class="p-3 rounded-4 shadow-sm d-inline-block"
                style="background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%); border: 1px solid rgba(255,255,255,0.5);">
                <h2 class="fw-bold text-dark m-0 d-flex align-items-center gap-2">
                    <i class="bi bi-wallet2 text-primary fs-3"></i>
                    <span>Finance Tracker</span>
                    <span class="badge bg-primary fs-6 rounded-pill">Pro</span>
                </h2>
            </div>

            <!-- Right Controls -->
            <div class="d-flex align-items-center gap-3">
                <!-- Clock Desktop -->
                <div id="liveClock" class="d-none d-md-block text-end pe-3 border-end">
                    <div class="fw-bold text-dark h5 mb-0" id="clockTime">--:--</div>
                    <small class="text-muted" id="clockDate">---</small>
                </div>

                <form th:action="@{/logout}" method="post" class="m-0">
                    <button type="submit" class="btn btn-outline-danger btn-action rounded-pill px-4">
                        <i class="bi bi-box-arrow-right me-1"></i> Chiqish
                    </button>
                </form>
            </div>
        </div>

        <!-- Welcome Message -->
        <div class="text-center mb-5">
            <h1 class="display-6 fw-bold text-dark mb-0">
                Shaxsiy moliyangizga xush kelibsiz, <span class="text-primary"
                    th:text="${currentUser ?: 'Foydalanuvchi'}">Foydalanuvchi</span>!
            </h1>
            <p class="text-muted">Bugungi moliyaviy holatingizni nazorat qiling</p>
        </div>



        <!-- Statistika Kartochalari -->
        <div class="row mb-4 g-3">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card balance-card">
                    <div class="stat-label">Balans</div>
                    <div class="stat-value" th:text="|${formattedBalance} so'm|" th:title="${fullBalance}"
                        data-bs-toggle="tooltip">0.00 so'm</div>
                    <i class="bi bi-cash-stack position-absolute end-0 top-0 m-3 fs-1 opacity-25"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card income-card">
                    <div class="stat-label">Daromad</div>
                    <div class="stat-value" th:text="|${formattedIncome} so'm|" th:title="${fullIncome}"
                        data-bs-toggle="tooltip">0.00 so'm</div>
                    <i class="bi bi-graph-up-arrow position-absolute end-0 top-0 m-3 fs-1 opacity-25"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card expense-card">
                    <div class="stat-label">Xarajat</div>
                    <div class="stat-value" th:text="|${formattedExpense} so'm|" th:title="${fullExpense}"
                        data-bs-toggle="tooltip">0.00 so'm</div>
                    <i class="bi bi-graph-down-arrow position-absolute end-0 top-0 m-3 fs-1 opacity-25"></i>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card debt-card">
                    <div class="stat-label">Qarzlar</div>
                    <div class="stat-value" th:text="|${formattedUnpaidDebts} so'm|" th:title="${fullUnpaidDebts}"
                        data-bs-toggle="tooltip">0.00 so'm</div>
                    <i class="bi bi-credit-card-2-front position-absolute end-0 top-0 m-3 fs-1 opacity-25"></i>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-3 mb-lg-0">
                <div class="section-card h-100">
                    <h5 class="mb-4"><i class="bi bi-bar-chart-line"></i> 7 Kunlik Dinamika</h5>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="section-card h-100">
                    <h5 class="mb-4"><i class="bi bi-pie-chart"></i> Xarajatlar Taqsimoti</h5>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <hr>
                    <div class="mt-3">
                        <small class="text-muted">Eng ko'p xarajat qilingan kategoriyalar</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Transactions & Debts -->
            <div class="col-lg-8">

                <!-- Budjet Limitlari (Progress Bars) -->
                <div class="section-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Budjet Limitlari</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#limitModal">
                            <i class="bi bi-plus"></i> Limit Qo'shish
                        </button>
                    </div>

                    <div th:each="status : ${budgetStatuses}" class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold" th:text="${status.category}">Category</span>
                            <small class="text-muted">
                                <span
                                    th:text="${#numbers.formatDecimal(status.spentAmount, 1, 'WHITESPACE', 0, 'POINT')}">0</span>
                                /
                                <span
                                    th:text="${#numbers.formatDecimal(status.limitAmount, 1, 'WHITESPACE', 0, 'POINT')}">1000</span>
                                <a th:href="@{/limits/delete/{id}(id=${status.id})}" class="text-danger ms-2"
                                    onclick="return confirm('Limitni o\'chirasizmi?')"><i class="bi bi-trash"></i></a>
                            </small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" th:classappend="${status.colorClass}" role="progressbar"
                                th:style="'width: ' + ${status.safePercentage} + '%'"
                                th:aria-valuenow="${status.safePercentage}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(budgetStatuses)}" class="text-center text-muted py-3">
                        <small>Hozircha limitlar o'rnatilmagan.</small>
                    </div>
                </div>

                <!-- Tranzaksiya Qo'shish -->
                <div class="section-card">
                    <h5 class="mb-3"><i class="bi bi-plus-lg"></i> Tranzaksiya</h5>
                    <form th:action="@{/add}" th:object="${transaction}" method="post" class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" th:field="*{description}" placeholder="Tavsif"
                                required>
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="amountInput" class="form-control" th:field="*{amount}"
                                placeholder="Summa" required>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" th:field="*{type}" required>
                                <option value="Expense">Xarajat</option>
                                <option value="Income">Daromad</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" th:field="*{category}" required>
                                <option value="" disabled selected>Kategoriya tanlang</option>
                                <option th:each="limit : ${categoryLimits}" th:value="${limit.category}"
                                    th:text="${limit.category}">
                                </option>
                                <option value="Other">Boshqa</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="datePicker" class="form-control" th:field="*{date}"
                                placeholder="Sana tanlang" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-check-lg"></i></button>
                        </div>
                    </form>
                </div>

                <!-- Oxirgi Tranzaksiyalar -->
                <div class="section-card">
                    <h5><i class="bi bi-list-task"></i> Oxirgi Tranzaksiyalar</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <a th:href="@{/(sortBy='date', direction=${sortBy == 'date' ? reverseDirection : 'desc'})}"
                                            class="text-decoration-none text-dark">
                                            Sana <i th:if="${sortBy == 'date'}"
                                                th:class="${direction == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a th:href="@{/(sortBy='category', direction=${sortBy == 'category' ? reverseDirection : 'asc'})}"
                                            class="text-decoration-none text-dark">
                                            Kategoriya <i th:if="${sortBy == 'category'}"
                                                th:class="${direction == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a th:href="@{/(sortBy='description', direction=${sortBy == 'description' ? reverseDirection : 'asc'})}"
                                            class="text-decoration-none text-dark">
                                            Tavsif <i th:if="${sortBy == 'description'}"
                                                th:class="${direction == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                        </a>
                                    </th>
                                    <th class="text-end">
                                        <a th:href="@{/(sortBy='amount', direction=${sortBy == 'amount' ? reverseDirection : 'desc'})}"
                                            class="text-decoration-none text-dark">
                                            Summa <i th:if="${sortBy == 'amount'}"
                                                th:class="${direction == 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                        </a>
                                    </th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="t : ${transactions}">
                                    <td th:text="${#temporals.format(t.date, 'dd.MM')}">01.01</td>
                                    <td><span class="badge"
                                            th:classappend="${t.type == 'Income' ? 'badge-income' : 'badge-expense'}"
                                            th:text="${t.category}">Food</span></td>
                                    <td th:text="${t.description}">Lunch</td>
                                    <td class="text-end fw-bold"
                                        th:classappend="${t.type == 'Income' ? 'text-success' : 'text-danger'}"
                                        th:text="${(t.type == 'Income' ? '+' : '-') + #numbers.formatDecimal(t.amount, 1, 'WHITESPACE', 2, 'POINT')}">
                                        -50 000.00
                                    </td>
                                    <td class="text-end">
                                        <a th:href="@{/delete/{id}(id=${t.id})}" class="text-muted"
                                            onclick="return confirm('O\'chirasizmi?')"><i class="bi bi-trash"></i></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Right Column: Debts & Forms -->
            <div class="col-lg-4">

                <!-- Qarzlar -->
                <div class="section-card">
                    <h5 class="mb-3"><i class="bi bi-hourglass-split"></i> Qarzlar</h5>

                    <div th:each="d : ${debts}" class="card mb-2 border-0 shadow-sm bg-light">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1 fw-bold" th:text="${d.lenderName}">John</h6>
                                <span class="badge rounded-pill"
                                    th:classappend="${d.status == 'Unpaid' ? 'badge-unpaid' : 'badge-paid'}"
                                    th:text="${d.status == 'Unpaid' ? 'To''lanmagan' : 'To''langan'}">Status</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="text-danger fw-bold"
                                    th:text="${#numbers.formatDecimal(d.amount, 1, 'WHITESPACE', 0, 'POINT')}">10
                                    000</span>
                                <div>
                                    <a th:if="${d.status == 'Unpaid'}" th:href="@{/debts/pay/{id}(id=${d.id})}"
                                        class="btn btn-sm btn-success py-0 px-2"
                                        onclick="return confirm('Qarz to\'landimi?')"><i class="bi bi-check"></i></a>
                                    <a th:href="@{/debts/delete/{id}(id=${d.id})}" class="text-muted ms-2"><i
                                            class="bi bi-trash"></i></a>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                                Qaytarish: <span
                                    th:text="${#temporals.format(d.returnDate, 'dd.MM.yyyy')}">01.01.2024</span>
                            </small>
                        </div>
                    </div>

                    <hr>
                    <button class="btn btn-outline-secondary w-100 btn-sm" type="button" onclick="toggleDebtForm()">
                        + Yangi Qarz
                    </button>

                    <div class="mt-3" id="debtForm" style="display: none;">
                        <form th:action="@{/debts/add}" th:object="${debt}" method="post">
                            <input type="text" class="form-control mb-2 form-control-sm" th:field="*{lenderName}"
                                placeholder="Kimdan/Kimga" required>
                            <input type="number" class="form-control mb-2 form-control-sm" th:field="*{amount}"
                                placeholder="Summa" required>
                            <div class="row g-1">
                                <div class="col-6"><input type="date" class="form-control form-control-sm"
                                        th:field="*{loanDate}" required></div>
                                <div class="col-6"><input type="date" class="form-control form-control-sm"
                                        th:field="*{returnDate}" required></div>
                            </div>
                            <button type="submit" class="btn btn-dark w-100 btn-sm mt-2">Qo'shish</button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Limit Modal -->
    <div class="modal fade" id="limitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Budjet Limiti O'rnatish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/limits/add}" th:object="${newLimit}" method="post">
                        <div class="mb-3">
                            <label class="form-label">Kategoriya</label>
                            <input type="text" class="form-control" th:field="*{category}"
                                placeholder="Masalan: Oziq-ovqat" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Oylik Limit (so'm)</label>
                            <input type="number" class="form-control" th:field="*{limitAmount}" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Saqlash</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Cleave.js -->
    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>

    <!-- Charts Logic & UI Scripts -->
    <script th:inline="javascript">
        /*<![CDATA[*/

        // 0. UI INITIALIZATION (Clock, Picker, Formatter)
        document.addEventListener('DOMContentLoaded', function () {
            // A. Real-time Clock (Uzbek)
            function updateClock() {
                const now = new Date();

                // Oy nomlari o'zbek tilida
                const months = [
                    "yanvar", "fevral", "mart", "aprel", "may", "iyun",
                    "iyul", "avgust", "sentyabr", "oktyabr", "noyabr", "dekabr"
                ];

                // Hafta kunlari o'zbek tilida
                const weekDays = [
                    "yakshanba", "dushanba", "seshanba", "chorshanba",
                    "payshanba", "juma", "shanba"
                ];

                const day = now.getDate();
                const month = months[now.getMonth()];
                const weekDay = weekDays[now.getDay()];

                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');

                // Format: "28-yanvar, chorshanba, 13:13"
                const dateString = `${day}-${month}, ${weekDay}`;
                const timeString = `${hours}:${minutes}`;

                // Update DOM elements if they exist
                const timeEl = document.getElementById('clockTime');
                const dateEl = document.getElementById('clockDate');

                if (timeEl) timeEl.textContent = timeString;
                if (dateEl) dateEl.textContent = dateString;
            }
            setInterval(updateClock, 1000);
            updateClock(); // Initial call

            // B. Flatpickr (Modern Date Picker)
            flatpickr("#datePicker", {
                dateFormat: "Y-m-d", // Backend expects YYYY-MM-DD
                altInput: true,
                altFormat: "d-m-Y", // User sees 28-01-2026
                defaultDate: "today",
                locale: {
                    firstDayOfWeek: 1
                }
            });

            // C. Cleave.js (Amount Formatting)
            new Cleave('#amountInput', {
                numeral: true,
                numeralThousandsGroupStyle: 'thousand',
                delimiter: ' ',
                numeralDecimalScale: 2
            });

            // Note: Cleave formats value in UI. On submit, backend might need to strip spaces.
            // However, Spring Boot binding often handles standard numbers. 
            // If binding fails, we might need to strip spaces in 'onsubmit'.
            // For now, assuming binding might fail if spaces are sent, let's fix it.
            document.querySelector('form[action$="/add"]').addEventListener('submit', function (e) {
                const amountInput = document.getElementById('amountInput');
                // Remove spaces before submitting to ensure Double parsing works
                amountInput.value = amountInput.value.replace(/\s/g, '');
            });
        });

        // 1. PIE CHART DATA
        // 1. PIE CHART DATA
        const expenseData = /*[[${expenseByCategory}]]*/[];
        const pieLabels = expenseData.map(item => item[0]);
        const pieValues = expenseData.map(item => item[1]);

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieValues,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 10 } }
                }
            }
        });

        // Initialize Bootstrap Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // 2. BAR CHART DATA
        const historyData = /*[[${last7DaysStats}]]*/[];
        // historyData structure: [DateString ("dd.MM"), Income, Expense]
        const barLabels = historyData.map(item => item[0]);
        const incomeValues = historyData.map(item => item[1]);
        const expenseValues = historyData.map(item => item[2]);

        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: barLabels,
                datasets: [
                    {
                        label: 'Daromad',
                        data: incomeValues,
                        backgroundColor: '#38ef7d',
                        borderRadius: 5
                    },
                    {
                        label: 'Xarajat',
                        data: expenseValues,
                        backgroundColor: '#ff6b6b',
                        borderRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                }
            }
        });
        /*]]>*/

        function toggleDebtForm() {
            var form = document.getElementById('debtForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
</body>

</html>